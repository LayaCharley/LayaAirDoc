# OPPO小游戏



## 一、概述

推荐要看一看OPPO小游戏官方的[文档](https://ie-activity-cn.heytapimage.com/static/minigame/CN/docs/index.html)，LayaAir引擎的文档更多的是引擎相关的，当然也会混合了一些小游戏接口的应用介绍，但是仔细看看OPPO官方文档肯定没错。

OPPO官方提供了可视化开发者工具，点击[这里](https://ie-activity-cn.heytapimage.com/static/minigame/CN/docs/index.html#/develop/games/ide)下载，在LayaAirIDE中配置好相关参数，然后直接在LayaAirIDE内一键发布成功（还会生成一个rpk的包），就可以用OPPO开发者工具调试了。

另一种调试方式则是通过OPPO手机里安装一个apk调试环境，在apk里选择打开rpk的文件，然后通过chrome在PC上用数据线连接手机进行调试。



## 二、发布为OPPO小游戏

### 2.1 选择目标平台

点击构建发布，在弹出的构建发布界面里，选择发布平台为OPPO小游戏。如图2-1所示

<img src="img/2-1.png" style="zoom: 80%;" /> 

（图2-1）

下面我们来介绍一下这些功能参数的填写

**1、游戏名称**

一般都填写中文汉字，英文也可以。用于应用商店、桌面图标、弹窗等游戏入口处。一个好的名字是游戏能不能吸量的重要元素。OPPO是6个汉字以内就可以

**2、游戏包名**

游戏包名的格式是 `com.company.module` 第一位com不要变，第二位是公司名，第三位是项目名。都要写英文，例如：`com.layabox.demoGame`。

**3、游戏图标**

游戏图标也是重要的游戏入口标识，和游戏名称一样，是非常重要的吸量元素，如果游戏图标设计的好，游戏名称起的好。同样的位置会获得比其它游戏更多的点击率。游戏图标需要提供 `192*192` 的正方形尺寸。

**4、游戏版本名称**

游戏版本名称是真实的版本，一般是用于功能性版本的区别。比如我有个大版本改动。原来是1.0，可以变成2.0，如果只是改改Bug，那1.0完全可以改成1.1。以此类推，我们建议采用浮点数命名。比如“0.1”、“1.3”、“5.0”……

**5、游戏版本**

游戏版本与版本名称用处不同，这里是渠道平台用于区别版本更新。每次提审都要至少递归+1，自己测试无所谓。但是提审这里的值必须要比上次提审的值至少要+1，+N也是可以的，绝对不能等于或者小于上个版本值，建议是提审版本号递归+1。这里需要注意的是，游戏版本必须为正整数。

**6、最小平台版本**

最小平台版本，按调试器上显示的平台版本号，进行填写即可。

**7、日志等级**

七种日志等级，先级从高到底依次为OFF、ERROR、WARN、INFO、LOG、DEBUG、TRACE，可以方便地知道当前程序的运行状态。

**8、是否使用正式版签名**

如果只是测试版本调试，这里可以不用勾选。正式上线发布前（提版本到平台）必须勾选。

如果勾选了，就会启用正式版签名。关于release签名:

①对于公司,一般一个公司只用一个签名，如果公司已经有签名了，推荐使用公司的签名。如果没有的话，IDE中的发布集成了这个功能，方便开发者生成签名。

②对于个人开发者，可以多个项目使用一个正式签名。只需要生成一次即可。

如果已经release签名了，将签名文件放到Laya项目 sign/release 文件夹下



### 2.2 发布后的小游戏目录介绍

点击版本发布，由于在发布前会检查rpk发布环境（用于生成rpk包），如果没有发布环境的，则会开始下载。

发布后的目录结构如图2-2所示

<img src="img/2-2.png" style="zoom:50%;" /> 

（图2-2）

**`js` 项目文件 与 `libs` 引擎库目录**

项目代码和类库

**`resources`资源目录 与 Scene.js**

resources资源目录和资源文件Scene.js，小游戏由于初始包的限制，建议将初始包的内容在规划好，最好能放到统一的目录下，便于初始包的剥离。

**`main.js`OPPO小游戏的入口文件**

游戏项目入口JS文件与适配库JS等都是在这里进行引入。IDE创建项目的时候已生成好，一般情况下，这里不需要动。

**`manifest.json` 小游戏的项目配置文件**

文件里包括了小游戏项目的一些信息，如果想修改，可以直接在这里面编辑。



## 三、Chrome联调OPPO小游戏

### 3.1 OPPO小游戏发布、调试环境准备

1、OPPO品牌的手机。

2、下载安装OPPO真机测试APP “快应用”（OPPO 小游戏调试器 ）

前往OPPO官网[文档](https://ie-activity-cn.heytapimage.com/static/minigame/CN/docs/index.html#/develop/games/use) 找到`安装 runtime.apk 包到 OPPO 手机上`这个栏目，通常会选择新版本，进行下载。

要注意的是，调试器的版本，文档中有注明最小平台版本号。LayaAirIDE发布的时候，要和这里最小平台版本号对应上。

3、PC电脑的chrome浏览器与手机数据连接线。

4、安装node.js 环境， 这里推荐安装14.x.x 稳定版本(10.x.x 以上版本可能出现不兼容问题)，node官网：https://nodejs.org/en/。

就是下载安装，比较简单，也不细介绍。能在命令行里调起npm命令就算是成功了。

5、安装ADB

OPPO发布时，是通过 ADB 把rpk包推到手机的games目录上去，所以这个必须要装。

[ ADB官网下载: http://adbshell.com/downloads ]

> 提示一下，下载 ADB Kits，下载后的压缩包，建议解压放到一个路径简单一些的目录（如: `D:\adb`）。要记得添加环境变量（不知如何添加环境变量的可自行百度）。



### 3.2 OPPO小游戏发布与接入完整流程

为了让发布OPPO顺利一些，有一些检查工作我们要做。

第一、PC里，node环境、ADB、Chrome这些，都必须要安装好。

第二、在OPPO的手机里，进入`设置-> 其它设置-> 开发者选项` ，开发者选项与USB调试必须开启，如图3-1所示。

<img src="img/3-1.png" alt="图1" style="zoom:67%;" /> 

(图3-1)

另外要确保安装好OPPO小游戏调试环境“快应用”，如图3-2所示。

<img src="img/3-2.png" alt="图2" style="zoom: 67%;" /> 

(图3-2)

第三、将PC电脑与手机用USB数据线相连，电脑里，可以出现类似图3-3一样的界面。比如，点击图3-3左上角的OPPO R9m，就可以进入手机存储。

![图3](img/3-3.png) 

(图3-3)

手机里要注意的是，屏幕保持点亮打开，在PC的IDE发布OPPO小游戏时，如果手机出现授权信息请求的时候，一定要点确定允许。如图3-4所示。

<img src="img/3-4.png" alt="图4" style="zoom:50%;" />  

（图3-4）



### 3.3 真机调试与Chrome输出

OPPO的调试必须基于真机调试，PC的chrome只能输出信息，看不到画面。

如果准备工作没问题的话，正常情况下，LayaAirIDE里成功发布OPPO小游戏之后，是rpk的包会自动出现在小游戏的OPPO小游戏列表中的（IDE通过调用ADB推到指定的目录中），如图3-5所示。

![图5](img/3-5.png) 

（图3-5）

图3-5中的`OPPO测试`就是我们在发布的时候填写的游戏名称。如果我们看到自己对应的游戏名称，说明是正常发布成功了。点击秒开，就可以打开我们发布的游戏。

如果想看调试信息。这时就需要打开chrome浏览器。然后在输入栏里输入：

```
devtools://devtools/bundled/inspector.html?v8only=true&ws=10.10.82.111:12345/00010002-0003-4004-8005-000600070008
```

上面示例的IP地址`10.10.82.111`替换成自己手机上的IP就行，12345是端口号，不行的话就换成12346。IP地址不知道怎么查的，自行百度。这里重点提示的是，**PC电脑必须要和手机处于同一个网段的局域网环境下**，调试时要保证手机打开在小游戏页面。

如果没问题，效果如图3-6所示，会打印出调试日志。

![3-6](img/3-6.png)

（图3-6）

发布与调试，顺利的话至此就完成了。

### 3.4 发布未成功的处理经验

发布文档中只讲功能使用，上面的文档是顺利情况下的流程。然而开发者可能不会那么顺利，那这里我们讲一讲经验。

**调试列表中未见游戏，是什么情况**

如果我们发布的时候没能将rpk自动发到小游戏目录内，那图3-5的列表中，就没办法直接看到刚发布的小游戏。

这时候就可以使用adb来确认环境了。

在cmd中 输入 `adb devices` 指令。

**1.连接非正常情况：**

![图7-1](img/3-7-1.png) 

（图3-7-1）

此时就开发者需要检查手机连接，和权限是否正确。

**2.在连接正常情况下：**

![图7-1](img/3-7-2.png) 

（图3-7-2）

这时说明手机已经连接成功，并且已经开起来了开发者模式与usb调试。此时可以尝试重启OPPO的快应用apk，再查看列表信息。

**在连接正常的情况下**，如果再出现问题。可能就和windows权限有关系，需要确保使用管理员权限启动LayaAirIDE。

关于adb相关，或者手机权限相关的问题，开发者可以自行了解。

------

另一方案，使我们可以采用手动模式，把rpk包，复制到**手机存储的games目录下**，如果没有games目录则自己手工创建一下。

rpk包位于项目的release/OPPOgame/dist 目录下。

 将发布生成的rpk文件，复制到手机存储的games目录下，如图3-8所示。

![3-8](img/3-8.png)

（图3-8）

这种方法稳定性更高。

在 `.rpk` 文件生成成功的情况下，实际上发布流程已经结束。

如果打包流程出现问题，可以把问题反馈给Layabox官方团队，Layabox会与OPPO团队共同处理。



## 四、OPPO开发者工具调试

除了Chrome调试，开发者还可以使用官方提供的开发者工具。如图4-1所示，打开OPPO开发者工具，点击导入游戏引擎工程，然后选择路径即可。

<img src="img/4-1.png" alt="4-1" style="zoom:50%;" />

（图4-1）

然后选择编译方式，如图4-2所示，默认为普通编译，如果进行了分包，则选择“编译分包”，选择后点击“编译”。

<img src="img/4-2.png" alt="4-2" style="zoom:50%;" />

（图4-2）

编译成功后，usb连接真机，然后点击真机运行：

<img src="img/4-3.png" alt="4-3" style="zoom:50%;" />

（图4-3）

真机效果如图4-4所示：

<img src="img/4-4.png" alt="4-4" style="zoom:50%;" />

（图4-4）

此种方式相比Chrome浏览器调试的优势是，它能够实时显示手机的效果。



## 五、分包加载

让开发者在开发完成后，能够将项目中分包之外的其他文件打包成主包；再将整个包打成 .rpk 文件。开发者可以先看一下[《Web发布》](../../web/readme.md)的分包。

> OPPO分包加载包大小的限制
>
> - 整个小游戏所有分包大小之和不超过 16 M
> - 单个分包大小无限制
> - 加上主包 4M，最终的 rpk 包大小不超过 20M
>
> 详细请参考官网[文档](https://ie-activity-cn.heytapimage.com/static/minigame/CN/docs/index.html#/develop/subpackage/subpackage)。

使用LayaAirIDE分包，只需点击构建发布后，勾选开启分包，然后选择要分包的文件夹即可。在设置时需要注意，如果是代码加载的资源，在场景里没有引用，那么一定要添加到`始终包含的资源目录`。

发布后，开发者只需根据第三节、第四节的任一种调试方法进行调试即可。

